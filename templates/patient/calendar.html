{% extends "patient/base.html" %}

{% block title %}Mi Calendario - Moscowle{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-8">
    <h2 class="text-3xl font-bold text-charcoal mb-2">Mi Calendario</h2>
    <p class="text-gray-600">Gestiona tus citas y sesiones de terapia</p>
</div>

<!-- Upcoming Appointments -->
<div class="bg-white rounded-soft shadow-soft p-6 mb-6">
    <h3 class="text-xl font-semibold text-charcoal mb-6 flex items-center">
        <i class="fas fa-calendar-check text-olive mr-3"></i>
        Próximas Citas
    </h3>
    
    <div class="space-y-4" id="appointments-list">
        <div class="text-center py-12">
            <i class="fas fa-calendar-plus text-gray-300 text-5xl mb-4"></i>
            <p class="text-gray-500 mb-2">No tienes citas programadas</p>
            <p class="text-sm text-gray-400">Tu terapeuta programará las sesiones</p>
        </div>
    </div>
</div>

<!-- Calendar View -->
<div class="bg-white rounded-soft shadow-soft p-6">
    <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold text-charcoal flex items-center">
            <i class="fas fa-calendar text-olive mr-3"></i>
            Vista del Mes
        </h3>
        <div class="flex items-center space-x-4">
            <button id="prev-month" class="w-10 h-10 rounded-lg border border-gray-300 flex items-center justify-center hover:bg-gray-50 transition-colors">
                <i class="fas fa-chevron-left text-gray-600"></i>
            </button>
            <span id="current-month" class="text-lg font-semibold text-charcoal min-w-[200px] text-center">Diciembre 2025</span>
            <button id="next-month" class="w-10 h-10 rounded-lg border border-gray-300 flex items-center justify-center hover:bg-gray-50 transition-colors">
                <i class="fas fa-chevron-right text-gray-600"></i>
            </button>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div class="grid grid-cols-7 gap-2">
        <!-- Day Headers -->
        <div class="text-center py-2 text-sm font-semibold text-gray-600">Dom</div>
        <div class="text-center py-2 text-sm font-semibold text-gray-600">Lun</div>
        <div class="text-center py-2 text-sm font-semibold text-gray-600">Mar</div>
        <div class="text-center py-2 text-sm font-semibold text-gray-600">Mié</div>
        <div class="text-center py-2 text-sm font-semibold text-gray-600">Jue</div>
        <div class="text-center py-2 text-sm font-semibold text-gray-600">Vie</div>
        <div class="text-center py-2 text-sm font-semibold text-gray-600">Sáb</div>
        
        <!-- Calendar Days (will be generated by JS) -->
        <div id="calendar-days"></div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let currentDate = new Date();
    let appointments = [];
    
    function loadAppointments() {
        // Load upcoming appointments for the list
        fetch('/api/appointments/patient')
            .then(res => res.json())
            .then(data => {
                appointments = data;
                displayAppointmentsList();
                renderCalendar();
            })
            .catch(err => console.error('Error loading appointments:', err));
    }
    
    function displayAppointmentsList() {
        const listContainer = document.getElementById('appointments-list');
        
        if (appointments.length === 0) {
            listContainer.innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-calendar-plus text-gray-300 text-5xl mb-4"></i>
                    <p class="text-gray-500 mb-2">No tienes citas programadas</p>
                    <p class="text-sm text-gray-400">Tu terapeuta programará las sesiones</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        appointments.forEach(appt => {
            const startDate = new Date(appt.start);
            const dateStr = startDate.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const timeStr = startDate.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            const statusColors = {
                'scheduled': 'bg-blue-100 text-blue-700',
                'completed': 'bg-green-100 text-green-700',
                'cancelled': 'bg-red-100 text-red-700'
            };
            const statusText = {
                'scheduled': 'Programada',
                'completed': 'Completada',
                'cancelled': 'Cancelada'
            };
            
            html += `
                <div class="border border-gray-200 rounded-xl p-4 hover:border-olive transition-colors">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h4 class="font-semibold text-charcoal mb-1">${appt.title || 'Sesión de Terapia'}</h4>
                            <div class="space-y-1 text-sm text-gray-600">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-calendar text-olive"></i>
                                    <span>${dateStr}</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-clock text-olive"></i>
                                    <span>${timeStr}</span>
                                </div>
                                ${appt.location ? `
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-location-dot text-olive"></i>
                                    <span>${appt.location}</span>
                                </div>
                                ` : ''}
                                ${appt.therapist ? `
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-user-doctor text-olive"></i>
                                    <span>${appt.therapist.name}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${statusColors[appt.status] || 'bg-gray-100 text-gray-700'}">
                            ${statusText[appt.status] || appt.status}
                        </span>
                    </div>
                    ${appt.notes ? `
                    <div class="mt-3 pt-3 border-t border-gray-100 text-sm text-gray-600">
                        <i class="fas fa-note-sticky text-olive mr-2"></i>${appt.notes}
                    </div>
                    ` : ''}
                </div>
            `;
        });
        
        listContainer.innerHTML = html;
    }
    
    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
            "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;
        
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        // Get appointments for this month
        const monthStart = new Date(year, month, 1);
        const monthEnd = new Date(year, month + 1, 0);
        
        // Find which days have appointments
        const appointmentDays = new Set();
        appointments.forEach(appt => {
            const apptDate = new Date(appt.start);
            if (apptDate >= monthStart && apptDate <= monthEnd) {
                appointmentDays.add(apptDate.getDate());
            }
        });
        
        let html = '';
        
        // Empty cells for days before month starts
        for (let i = 0; i < firstDay; i++) {
            html += '<div class="aspect-square"></div>';
        }
        
        // Days of the month
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const isToday = day === today.getDate() && 
                           month === today.getMonth() && 
                           year === today.getFullYear();
            const hasAppointment = appointmentDays.has(day);
            
            html += `
                <div class="aspect-square p-2 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors relative ${isToday ? 'bg-olive text-white border-olive' : ''}">
                    <div class="text-sm font-medium text-center">${day}</div>
                    ${hasAppointment ? `<div class="absolute bottom-1 left-1/2 transform -translate-x-1/2 w-1.5 h-1.5 bg-blue-500 rounded-full ${isToday ? 'bg-white' : ''}"></div>` : ''}
                </div>
            `;
        }
        
        document.getElementById('calendar-days').innerHTML = html;
    }
    
    document.getElementById('prev-month').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });
    
    document.getElementById('next-month').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });
    
    // Initial load
    loadAppointments();
</script>
{% endblock %}
