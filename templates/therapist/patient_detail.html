{% extends "therapist/base.html" %}

{% block title %}{{ patient.username }} - Detalle del Paciente{% endblock %}

{% block header_content %}
<div class="flex items-center justify-between w-full">
    <div>
        <div class="flex items-center space-x-3">
            <a href="{{ url_for('manage_patients') }}" class="text-gray-400 hover:text-primary">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h2 class="text-2xl font-bold text-textDark">{{ patient.username or patient.email }}</h2>
        </div>
        <p class="text-sm text-gray-500">Historial completo del paciente</p>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="p-8">
    
    <!-- Patient Header Card -->
    <div class="bg-gradient-to-r from-primary to-green-600 rounded-soft shadow-soft p-8 mb-8 text-white">
        <div class="flex items-start justify-between">
            <div class="flex items-center space-x-6">
                <img src="https://ui-avatars.com/api/?name={{ patient.username or patient.email }}&size=100&background=random" 
                     class="w-24 h-24 rounded-full border-4 border-white" alt="Avatar">
                <div>
                    <h3 class="text-3xl font-bold mb-2">{{ patient.username or 'Paciente' }}</h3>
                    <p class="text-green-100 mb-3">{{ patient.email }}</p>
                    <div class="flex items-center space-x-4 text-sm">
                        {% if patient.phone %}
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-phone"></i>
                            <span>{{ patient.phone }}</span>
                        </div>
                        {% endif %}
                        {% if patient.date_of_birth %}
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-cake-candles"></i>
                            <span>{{ patient.date_of_birth.strftime('%d/%m/%Y') }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <button onclick="openEditModal()" class="bg-white text-primary px-6 py-3 rounded-xl font-medium hover:bg-opacity-90 transition-colors">
                <i class="fas fa-edit mr-2"></i>Editar Información
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-soft shadow-soft p-6">
            <div class="flex items-center justify-between mb-3">
                <i class="fas fa-gamepad text-3xl text-blue-500"></i>
            </div>
            <p class="text-3xl font-bold text-textDark">{{ total_sessions }}</p>
            <p class="text-sm text-gray-500">Sesiones Totales</p>
        </div>
        <div class="bg-white rounded-soft shadow-soft p-6">
            <div class="flex items-center justify-between mb-3">
                <i class="fas fa-bullseye text-3xl text-green-500"></i>
            </div>
            <p class="text-3xl font-bold text-textDark">{{ avg_accuracy }}%</p>
            <p class="text-sm text-gray-500">Precisión Promedio</p>
        </div>
        <div class="bg-white rounded-soft shadow-soft p-6">
            <div class="flex items-center justify-between mb-3">
                <i class="fas fa-clock text-3xl text-yellow-500"></i>
            </div>
            <p class="text-3xl font-bold text-textDark">{{ avg_time }}s</p>
            <p class="text-sm text-gray-500">Tiempo Promedio</p>
        </div>
        <div class="bg-white rounded-soft shadow-soft p-6">
            <div class="flex items-center justify-between mb-3">
                <i class="fas fa-calendar-check text-3xl text-purple-500"></i>
            </div>
            <p class="text-3xl font-bold text-textDark">{{ completed_appointments }}</p>
            <p class="text-sm text-gray-500">Citas Completadas</p>
        </div>
    </div>

    <div class="grid grid-cols-3 gap-8">
        <!-- Left Column -->
        <div class="col-span-2 space-y-8">
            
            <!-- Progress Chart -->
            <div class="bg-white rounded-soft shadow-soft p-6">
                <h3 class="text-xl font-bold text-textDark mb-6">Evolución de Precisión</h3>
                <canvas id="progressChart" height="80"></canvas>
            </div>

            <!-- Recent Sessions -->
            <div class="bg-white rounded-soft shadow-soft p-6">
                <h3 class="text-xl font-bold text-textDark mb-6">Sesiones Recientes</h3>
                <div class="space-y-3">
                    {% if recent_sessions %}
                        {% for session in recent_sessions %}
                        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-xl hover:border-primary transition-colors">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 rounded-full bg-lightGreen flex items-center justify-center">
                                    <i class="fas fa-gamepad text-primary"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-textDark">{{ session.game_name }}</p>
                                    <p class="text-sm text-gray-500">{{ session.date.strftime('%d %b %Y, %H:%M') }}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-6">
                                <div class="text-center">
                                    <p class="text-lg font-bold text-textDark">{{ session.accurracy|round(1) }}%</p>
                                    <p class="text-xs text-gray-500">Precisión</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-lg font-bold text-textDark">{{ session.avg_time|round(2) }}s</p>
                                    <p class="text-xs text-gray-500">Tiempo</p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-center text-gray-500 py-8">No hay sesiones registradas</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="space-y-8">
            
            <!-- Patient Info -->
            <div class="bg-white rounded-soft shadow-soft p-6">
                <h3 class="text-xl font-bold text-textDark mb-6">Información del Paciente</h3>
                <div class="space-y-4 text-sm">
                    {% if patient.guardian_name %}
                    <div>
                        <p class="text-gray-500 mb-1">Tutor/Responsable</p>
                        <p class="font-semibold text-textDark">{{ patient.guardian_name }}</p>
                        {% if patient.guardian_contact %}
                        <p class="text-gray-600">{{ patient.guardian_contact }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if patient.therapy_goals %}
                    <div>
                        <p class="text-gray-500 mb-1">Objetivos de Terapia</p>
                        <p class="text-textDark">{{ patient.therapy_goals }}</p>
                    </div>
                    {% endif %}
                    
                    {% if patient.notes %}
                    <div>
                        <p class="text-gray-500 mb-1">Notas Privadas</p>
                        <p class="text-textDark">{{ patient.notes }}</p>
                    </div>
                    {% endif %}
                    
                    <div>
                        <p class="text-gray-500 mb-1">Fecha de Registro</p>
                        <p class="text-textDark">{{ patient.created_at.strftime('%d de %B, %Y') }}</p>
                    </div>
                </div>
            </div>

            <!-- Upcoming Appointments -->
            <div class="bg-white rounded-soft shadow-soft p-6">
                <h3 class="text-xl font-bold text-textDark mb-6">Próximas Citas</h3>
                <div class="space-y-3">
                    {% if upcoming_appointments %}
                        {% for appt in upcoming_appointments %}
                        <div class="p-4 border border-gray-200 rounded-xl">
                            <p class="font-semibold text-textDark mb-1">{{ appt.title }}</p>
                            <p class="text-sm text-gray-600">
                                <i class="fas fa-calendar mr-2"></i>
                                {{ appt.start_time.strftime('%d %b, %H:%M') }}
                            </p>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-center text-gray-500 py-4">No hay citas programadas</p>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Edit Patient Modal -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-soft p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-bold text-textDark">Editar Información del Paciente</h3>
            <button onclick="closeEditModal()" class="text-gray-400 hover:text-textDark">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <form id="editForm" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-textDark mb-2">Teléfono</label>
                    <input type="tel" id="phone" value="{{ patient.phone or '' }}" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-textDark mb-2">Fecha de Nacimiento</label>
                    <input type="date" id="date_of_birth" value="{{ patient.date_of_birth.strftime('%Y-%m-%d') if patient.date_of_birth else '' }}"
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-textDark mb-2">Nombre del Tutor</label>
                    <input type="text" id="guardian_name" value="{{ patient.guardian_name or '' }}"
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-textDark mb-2">Contacto del Tutor</label>
                    <input type="text" id="guardian_contact" value="{{ patient.guardian_contact or '' }}"
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-textDark mb-2">Objetivos de Terapia</label>
                <textarea id="therapy_goals" rows="3"
                          class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">{{ patient.therapy_goals or '' }}</textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-textDark mb-2">Notas Privadas</label>
                <textarea id="notes" rows="4"
                          class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">{{ patient.notes or '' }}</textarea>
            </div>

            <div class="flex gap-4 pt-4">
                <button type="submit" class="flex-1 bg-primary text-white px-6 py-3 rounded-xl font-medium hover:bg-opacity-90 transition-colors">
                    <i class="fas fa-save mr-2"></i>Guardar Cambios
                </button>
                <button type="button" onclick="closeEditModal()" class="flex-1 bg-gray-200 text-textDark px-6 py-3 rounded-xl font-medium hover:bg-gray-300 transition-colors">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Progress Chart
    const ctx = document.getElementById('progressChart').getContext('2d');
    const sessions = {{ all_sessions | tojson }};
    
    const chartData = {
        labels: sessions.map(s => new Date(s.date).toLocaleDateString('es-ES', {day: 'numeric', month: 'short'})),
        datasets: [{
            label: 'Precisión (%)',
            data: sessions.map(s => s.accurracy),
            borderColor: '#75a83a',
            backgroundColor: 'rgba(117, 168, 58, 0.1)',
            tension: 0.4,
            fill: true
        }]
    };
    
    new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // Modal functions
    function openEditModal() {
        document.getElementById('editModal').classList.remove('hidden');
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
    }

    // Form submission
    document.getElementById('editForm').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const formData = {
            phone: document.getElementById('phone').value,
            date_of_birth: document.getElementById('date_of_birth').value,
            guardian_name: document.getElementById('guardian_name').value,
            guardian_contact: document.getElementById('guardian_contact').value,
            therapy_goals: document.getElementById('therapy_goals').value,
            notes: document.getElementById('notes').value
        };

        fetch('/patients/{{ patient.id }}/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert('✅ ' + data.message);
                location.reload();
            } else {
                alert('❌ ' + data.message);
            }
        })
        .catch(err => {
            console.error('Error:', err);
            alert('❌ Error al actualizar el paciente');
        });
    });
</script>
{% endblock %}
