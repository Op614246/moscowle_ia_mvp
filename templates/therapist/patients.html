{% extends "therapist/base.html" %} {% block header_content %}
<div>
  <h2 class="text-2xl font-bold text-textDark">Gestión de Pacientes</h2>
  <p class="text-sm text-gray-500">Administra los usuarios de la plataforma</p>
</div>
{% endblock %} {% block header_action %}
<button
  id="add-patient-btn"
  class="px-5 py-2 bg-primary text-white rounded-soft hover:bg-opacity-90 transition-all shadow-soft font-medium"
>
  <i class="fas fa-plus mr-2"></i>
  Nuevo Paciente
</button>
{% endblock %} {% block content %}
<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %} {% if messages
%}
<div class="px-8 py-4">
  {% for category, message in messages %}
  <div
    class="p-4 rounded-2xl mb-3 {% if category == 'error' %}bg-red-50 text-red-700 border border-red-200{% elif category == 'success' %}bg-green-50 text-green-700 border border-green-200{% else %}bg-yellow-50 text-yellow-700 border border-yellow-200{% endif %}"
  >
    {{ message | safe }}
  </div>
  {% endfor %}
</div>
{% endif %} {% endwith %}

<!-- Add Patient Modal -->
<div
  id="add-patient-modal"
  class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden flex items-center justify-center"
>
  <div
    class="bg-surface rounded-soft shadow-soft-lg w-full max-w-lg mx-auto p-8"
  >
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-bold text-textDark">Agregar Nuevo Paciente</h3>
      <button id="close-modal-btn" class="text-gray-400 hover:text-primary">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>
    <form
      method="POST"
      action="{{ url_for('add_patient') }}"
      class="grid grid-cols-2 gap-6"
    >
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2"
          >Nombre</label
        >
        <input
          type="text"
          name="username"
          class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
          placeholder="Nombre del paciente"
          required
        />
      </div>
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2"
          >Correo Electrónico</label
        >
        <input
          type="email"
          name="email"
          class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
          placeholder="correo@ejemplo.com"
          required
        />
      </div>
      <div class="col-span-2 mt-4">
        <button
          type="submit"
          class="w-full bg-primary text-white font-bold py-3 rounded-lg hover:bg-opacity-90 transition-all shadow-soft"
        >
          <i class="fa-solid fa-plus mr-2"></i> Registrar Paciente
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Patients List -->
<div class="px-8 py-6">
  <div class="bg-surface rounded-soft shadow-soft overflow-hidden">
    <div
      class="px-8 py-6 border-b border-gray-100 flex justify-between items-center"
    >
      <h3 class="text-xl font-bold text-textDark">Lista de Pacientes</h3>
      <div class="relative">
        <input
          type="text"
          placeholder="Buscar paciente..."
          class="pl-10 pr-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-primary"
        />
        <i
          class="fa-solid fa-search absolute left-3 top-3 text-gray-400 text-xs"
        ></i>
      </div>
    </div>
    <table class="w-full">
      <thead class="bg-gray-50">
        <tr>
          <th
            class="px-8 py-4 text-left text-xs font-bold text-gray-500 uppercase"
          >
            Paciente
          </th>
          <th
            class="px-8 py-4 text-left text-xs font-bold text-gray-500 uppercase"
          >
            Email
          </th>
          <th
            class="px-8 py-4 text-center text-xs font-bold text-gray-500 uppercase"
          >
            Estado
          </th>
          <th
            class="px-8 py-4 text-center text-xs font-bold text-gray-500 uppercase"
          >
            Acciones
          </th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        {% for patient in patients %}
        <tr
          class="hover:bg-lightGreen transition-colors cursor-pointer"
          onclick="window.location='{{ url_for('patient_detail',patient_id=patient.id) }}';"
        >
          <td class="px-8 py-4">
            <div class="flex items-center gap-3">
              <img
                src="https://ui-avatars.com/api/?name={{patient.username}}&background=random"
                class="w-10 h-10 rounded-full"
              />
              <span class="font-semibold text-textDark"
                >{{ patient.username }}</span
              >
            </div>
          </td>
          <td class="px-8 py-4 text-gray-600">{{ patient.email }}</td>
          <td class="px-8 py-4 text-center">
            <span
              class="px-3 py-1 rounded-full text-xs font-bold {% if patient.is_active %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}"
            >
              {{ 'Activo' if patient.is_active else 'Inactivo' }}
            </span>
          </td>
          <td class="px-8 py-4 text-center">
            <div class="flex items-center justify-center gap-2">
              <a
                href="{{ url_for('patient_detail', patient_id=patient.id) }}"
                class="p-2 text-gray-400 hover:text-primary transition-colors"
                title="Ver Detalle"
                onclick="event.stopPropagation()"
              >
                <i class="fa-solid fa-eye"></i>
              </a>
              <button
                onclick="event.stopPropagation(); toggleStatus({{ patient.id }})"
                class="p-2 text-gray-400 hover:text-primary transition-colors"
                title="Cambiar Estado"
              >
                <i class="fa-solid fa-power-off"></i>
              </button>
              <button
                onclick="event.stopPropagation(); deletePatient({{ patient.id }})"
                class="p-2 text-gray-400 hover:text-red-500 transition-colors"
                title="Eliminar"
              >
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="4" class="px-8 py-8 text-center text-gray-500">
            No hay pacientes registrados.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Confirmation Modal -->
<div
  id="confirm-modal"
  class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center"
>
  <div
    class="bg-surface rounded-soft shadow-soft-lg w-full max-w-md mx-auto p-6"
  >
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-bold text-textDark">Confirmación</h3>
      <button id="confirm-close" class="text-gray-400 hover:text-primary">
        <i class="fas fa-times text-lg"></i>
      </button>
    </div>
    <p id="confirm-message" class="text-gray-700 mb-6"></p>
    <div class="flex justify-end gap-3">
      <button
        id="confirm-cancel"
        class="px-4 py-2 rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200"
      >
        Cancelar
      </button>
      <button
        id="confirm-accept"
        class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-opacity-90"
      >
        Aceptar
      </button>
    </div>
  </div>
</div>

<script>
  document.getElementById("add-patient-btn").addEventListener("click", () => {
    document.getElementById("add-patient-modal").classList.remove("hidden");
  });
  document.getElementById("close-modal-btn").addEventListener("click", () => {
    document.getElementById("add-patient-modal").classList.add("hidden");
  });

  // Reusable Confirmation Modal Logic
  const confirmModal = document.getElementById("confirm-modal");
  const confirmMsg = document.getElementById("confirm-message");
  const confirmAccept = document.getElementById("confirm-accept");
  const confirmCancel = document.getElementById("confirm-cancel");
  const confirmClose = document.getElementById("confirm-close");

  function openConfirm(message, onAccept) {
    confirmMsg.textContent = message;
    confirmModal.classList.remove("hidden");
    confirmModal.classList.add("flex");
    const handler = async () => {
      try {
        await onAccept();
      } finally {
        closeConfirm();
      }
    };
    // Ensure old listeners are removed
    confirmAccept.replaceWith(confirmAccept.cloneNode(true));
    const newAccept = document.getElementById("confirm-accept");
    newAccept.addEventListener("click", handler);
  }

  function closeConfirm() {
    confirmModal.classList.add("hidden");
    confirmModal.classList.remove("flex");
  }

  confirmCancel.addEventListener("click", closeConfirm);
  confirmClose.addEventListener("click", closeConfirm);

  async function toggleStatus(id) {
    openConfirm(
      "¿Estás seguro de cambiar el estado de este paciente?",
      async () => {
        const response = await fetch(`/patients/toggle/${id}`, {
          method: "POST",
        });
        const data = await response.json();
        if (data.success) {
          location.reload();
        } else {
          alert("Error: " + (data.message || "No se pudo cambiar el estado"));
        }
      }
    );
  }

  async function deletePatient(id) {
    openConfirm(
      "¿Estás seguro de eliminar este paciente? Esta acción no se puede deshacer.",
      async () => {
        const response = await fetch(`/patients/delete/${id}`, {
          method: "POST",
        });
        const data = await response.json();
        if (data.success) {
          location.reload();
        } else {
          alert(
            "Error: " + (data.message || "No se pudo eliminar el paciente")
          );
        }
      }
    );
  }
</script>
{% endblock %}
